THREE.Binder={bind:function(t,e){return function(i,n){n.__binds||(n.__binds=[]);var s=t;_.isArray(i)&&(s=i[0],i=i[1]);for(var r=/^([^.:]*(?:\.[^.:]+)*)?(?:\:(.*))?$/.exec(i),a=r[1].split(/\./g),o=a.pop(),l=r[2]||o,p=a.shift(),h={"this":n}[p]||e[p]||t[p]||s;h&&(i=a.shift());)h=h[i];if(h&&(h.on||h.addEventListener)){var u=function(e){n[l]&&n[l](e,t)};THREE.Binder._polyfill(h,["addEventListener","on"],function(t){h[t](o,u)});var d={target:h,name:o,callback:u};return n.__binds.push(d),u}throw"Cannot bind '"+i+"' in "+this.__name}},unbind:function(){return function(t){t.__binds&&(t.__binds.forEach(function(t){THREE.Binder._polyfill(t.target,["removeEventListener","off"],function(e){t.target[e](t.name,t.callback)})}.bind(this)),t.__binds=[])}},apply:function(t){THREE.EventDispatcher.prototype.apply(t),t.trigger=THREE.Binder._trigger,t.triggerOnce=THREE.Binder._triggerOnce,t.on=t.addEventListener,t.off=t.removeEventListener,t.dispatchEvent=t.trigger},_triggerOnce:function(t){this.trigger(t),this._listeners&&delete this._listeners[t.type]},_trigger:function(t){if(void 0!==this._listeners){var e=t.type,i=this._listeners[e];if(void 0!==i){i=i.slice();var n=i.length;t.target=this;for(var s=0;n>s;s++)i[s].call(this,t,this)}}},_polyfill:function(t,e,i){e.map(function(){return t.method}),e.length&&i(e[0])}},THREE.Api={apply:function(t){t.set=function(t){var e=this.options||{},i=_.reduce(t,function(t,i,n){return e[n]!==i&&(t[n]=i),t},{});this.options=_.extend(e,i),this.trigger({type:"change",options:t,changes:i})},t.get=function(){return this.options},t.api=function(t,e){return t=t||{},e&&_.each(t,function(t,i,n){_.isFunction(t)&&(n[i]=_.partialRight(t,e))}),t.set=this.set.bind(this),t.get=this.get.bind(this),t}}},THREE.Bootstrap=function(t){if(t&&_.isString(t)&&(t=[].slice.apply(arguments)),_.isArray(t)&&(t={plugins:t}),!(this instanceof THREE.Bootstrap))return new THREE.Bootstrap(t);var e={init:!0,element:document.body,plugins:["core"],aliases:{},plugindb:THREE.Bootstrap.Plugins||{},aliasdb:THREE.Bootstrap.Aliases||{}};this.__options=_.defaults(t||{},e),this.__inited=!1,this.__destroyed=!1,this.__installed=[],this.plugins={},this.element=this.__options.element,this.__options.init&&this.init()},THREE.Bootstrap.prototype={init:function(){return this.__inited?void 0:(this.__inited=!0,this.install(this.__options.plugins),this)},destroy:function(){return this.__inited&&!this.__destroyed?(this.__destroyed=!0,this.trigger({type:"destroy"}),this.uninstall(),this):void 0},resolve:function(t){function e(t,i,s){if(s>=256)throw"Plug-in alias recursion detected.";return _.each(t,function(t){var r=n[t];r?i=i.concat(e(r,[],s+1)):i.push(t)}),i}t=_.isArray(t)?t:[t];var i=this.__options,n=_.extend({},i.aliasdb,i.aliases);return t=_.filter(t,function(t){var e=t.split(":");return e[1]?(n[e[0]]=e[1],!1):!0}),_.each(n,function(t,e){n[e]=_.isArray(t)?t:[t]}),e(t,[],0)},install:function(t){t=_.isArray(t)?t:[t],t=this.resolve(t),_.each(t,this.__install,this),this.__ready()},uninstall:function(t){t&&(t=_.isArray(t)?t:[t],t=this.resolve(t)),_.eachRight(t||this.__installed,this.__uninstall,this)},__install:function(t){var e=this.__options.plugindb[t];if(!e)throw"[three.install] Cannot install. '"+t+"' is not registered.";if(this.plugins[t])return console.warn("[three.install] "+t+" is already installed.");var i=e,n=new i(this.__options[t]||{},t);this.plugins[t]=n,n.install(this),this.__installed.push(n),this.trigger({type:"install",plugin:n})},__uninstall:function(t){return(plugin=_.isString(t)?this.plugins[t]:t)?(t=plugin.__name,plugin.uninstall(this),this.__installed=_.without(this.__installed,plugin),delete this.plugins[t],void this.trigger({type:"uninstall",plugin:plugin})):console.warn("[three.uninstall] "+t+"' is not installed.")},__ready:function(){this.triggerOnce({type:"ready"})}},THREE.Binder.apply(THREE.Bootstrap.prototype),THREE.Bootstrap.Plugins={},THREE.Bootstrap.Aliases={},THREE.Bootstrap.Plugin=function(t){this.options=_.defaults(t||{},this.defaults)},THREE.Bootstrap.Plugin.prototype={listen:[],defaults:{},install:function(){},uninstall:function(){}},THREE.Binder.apply(THREE.Bootstrap.Plugin.prototype),THREE.Api.apply(THREE.Bootstrap.Plugin.prototype),THREE.Bootstrap.registerPlugin=function(t,e){var i=function(e){THREE.Bootstrap.Plugin.call(this,e),this.__name=t};i.prototype=_.extend(new THREE.Bootstrap.Plugin,e),THREE.Bootstrap.Plugins[t]=i},THREE.Bootstrap.unregisterPlugin=function(t){delete THREE.Bootstrap.Plugins[t]},THREE.Bootstrap.registerAlias=function(t,e){THREE.Bootstrap.Aliases[t]=e},THREE.Bootstrap.unregisterAlias=function(t){delete THREE.Bootstrap.Aliases[t]},THREE.Bootstrap.registerAlias("empty",["renderer","bind","size","fill","loop","time"]),THREE.Bootstrap.registerAlias("core",["empty","scene","camera","render"]),THREE.Bootstrap.registerPlugin("renderer",{defaults:{klass:THREE.WebGLRenderer,parameters:{depth:!0,stencil:!0,preserveDrawingBuffer:!0,antialias:!0}},install:function(t){var e=t.renderer=new this.options.klass(this.options.parameters);t.canvas=e.domElement,t.element.appendChild(e.domElement)},uninstall:function(t){t.element.removeChild(t.renderer.domElement),delete t.renderer,delete t.canvas}}),THREE.Bootstrap.registerPlugin("bind",{install:function(t){var e={three:t,window:window};t.bind=THREE.Binder.bind(t,e),t.unbind=THREE.Binder.unbind(t),t.bind("install:bind",this),t.bind("uninstall:unbind",this)},uninstall:function(t){t.unbind(this),delete t.bind,delete t.unbind},bind:function(t,e){var i=t.plugin,n=i.listen;n&&n.forEach(function(t){e.bind(t,i)})},unbind:function(t,e){e.unbind(t.plugin)}}),THREE.Bootstrap.registerPlugin("size",{defaults:{width:null,height:null,aspect:null,scale:1,capWidth:1/0,capHeight:1/0},listen:["window.resize","element.resize","this.change:resize","ready:resize"],install:function(t){t.Size=this.api({renderWidth:0,renderHeight:0,viewWidth:0,viewHeight:0})},uninstall:function(t){delete t.Size},resize:function(t,e){var i,n,s,r,a,o,l,p,h=this.options,u=e.element,d=e.renderer,c=0,g=0;i=s=void 0===h.width||null==h.width?u.offsetWidth||u.innerWidth||0:h.width,n=r=void 0===h.height||null==h.height?u.offsetHeight||u.innerHeight||0:h.height,l=i/n,h.aspect&&(h.aspect>l?(n=Math.round(i/h.aspect),g=Math.floor((r-n)/2)):(i=Math.round(n*h.aspect),c=Math.floor((s-i)/2)),l=i/n),a=Math.min(i*h.scale,h.capWidth),o=Math.min(n*h.scale,h.capHeight),raspect=a/o,raspect>l?a=Math.round(o*l):o=Math.round(a/l),d.setSize(a,o),p=d.domElement.style,p.width=i+"px",p.height=n+"px",p.marginLeft=c+"px",p.marginTop=g+"px",_.extend(e.Size,{renderWidth:a,renderHeight:o,viewWidth:i,viewHeight:n,aspect:l}),e.trigger({type:"resize",renderWidth:a,renderHeight:o,viewWidth:i,viewHeight:n,aspect:l})}}),THREE.Bootstrap.registerPlugin("fill",{defaults:{block:!0,body:!0,layout:!0},install:function(t){function e(t){var e=t.style.height;return"auto"==e||""==e}function i(t){return t.style.height="100%",t.style.margin=0,t.style.padding=0,t}if(this.options.body&&t.element==document.body&&(this.applied=[t.element,document.documentElement].filter(e).map(i)),this.options.block&&t.canvas&&(t.canvas.style.display="block",this.block=!0),this.options.layout&&t.element){var n=window.getComputedStyle(t.element);"static"==n.position&&(t.element.style.position="relative",this.layout=!0)}},uninstall:function(t){function e(t){return t.style.height="",t.style.margin="",t.style.padding="",t}this.applied&&(this.applied.map(e),delete this.applied),this.block&&t.canvas&&(t.canvas.style.display="",delete this.block),this.layout&&t.element&&(t.element.style.position="",delete this.layout)},change:function(t){this.uninstall(t),this.install(t)}}),THREE.Bootstrap.registerPlugin("loop",{defaults:{start:!0},listen:["ready"],install:function(t){this.running=!1,t.Loop=this.api({start:this.start.bind(this),stop:this.stop.bind(this),running:!1},t),this.events=["pre","update","render","post"].map(function(t){return{type:t}})},uninstall:function(t){this.stop(t)},ready:function(t,e){this.options.start&&this.start(e)},start:function(t){if(!this.running){t.Loop.running=this.running=!0;var e=t.trigger.bind(t),i=function(){this.running&&requestAnimationFrame(i),this.events.map(e)}.bind(this);requestAnimationFrame(i),t.trigger({type:"start"})}},stop:function(t){this.running&&(t.Loop.running=this.running=!1,t.trigger({type:"stop"}))}}),THREE.Bootstrap.registerPlugin("time",{defaults:{speed:1},listen:["pre:tick","this.change"],install:function(t){t.Time=this.api({now:0,clock:0,step:1/60,frames:0,delta:1/60,average:0,fps:0}),this.last=0,this.clock=0},tick:function(t,e){var i=this.options.speed,n=e.Time,s=n.now=+new Date/1e3,r=this.last,a=this.clock;if(r){var o=n.delta=s-r,l=n.average||o;n.average=l+.1*(o-l),n.fps=1/l;var p=o*i;a+=p,n.step=p,n.clock=a,n.frames++}this.last=s,this.clock=a},uninstall:function(t){delete t.Time}}),THREE.Bootstrap.registerPlugin("scene",{install:function(t){t.scene=new THREE.Scene},uninstall:function(t){delete t.scene}}),THREE.Bootstrap.registerPlugin("camera",{defaults:{near:.1,far:1e4,type:"perspective",fov:60,aspect:null,left:-1,right:1,bottom:-1,top:1,klass:null,parameters:null},listen:["resize","this.change"],install:function(t){t.Camera=this.api(),t.camera=null,this.aspect=1,this.change({},t)},uninstall:function(t){delete t.Camera,delete t.camera},change:function(t,e){var i=this.options,n=e.camera;if(!e.camera||t.changes.type||t.changes.klass){var s=i.klass||{perspective:THREE.PerspectiveCamera,orthographic:THREE.OrthographicCamera}[i.type]||THREE.Camera;e.camera=i.parameters?new s(i.parameters):new s}_.each(i,function(t,n){e.camera.hasOwnProperty(n)&&(e.camera[n]=i[n])}.bind(this)),this.update(e),n===e.camera||e.trigger({type:"camera",camera:e.camera})},resize:function(t,e){this.aspect=t.viewWidth/Math.max(1,t.viewHeight),this.update(e)},update:function(t){t.camera.aspect=this.options.aspect||this.aspect,t.camera.updateProjectionMatrix()}}),THREE.Bootstrap.registerPlugin("render",{listen:["render"],render:function(t,e){e.scene&&e.camera&&e.renderer.render(e.scene,e.camera)}});