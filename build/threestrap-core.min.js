THREE.Binder={bind:function(t,e){return function(i,n){n.__binds||(n.__binds=[]);var s=t;_.isArray(i)&&(s=i[0],i=i[1]);for(var r=/^([^.:]*(?:\.[^.:]+)*)?(?:\:(.*))?$/.exec(i),a=r[1].split(/\./g),o=a.pop(),l=r[2]||o,h=a.shift(),p={"this":n}[h]||e[h]||t[h]||s;p&&(i=a.shift());)p=p[i];if(!p||!p.on&&!p.addEventListener)throw"Cannot bind '"+i+"' in "+this.__name;var u=function(e){n[l]&&n[l](e,t)};THREE.Binder._polyfill(p,["addEventListener","on"],function(t){p[t](o,u)});var d={target:p,name:o,callback:u};n.__binds.push(d)}},unbind:function(){return function(t){t.__binds&&(t.__binds.forEach(function(t){THREE.Binder._polyfill(t.target,["removeEventListener","off"],function(e){t.target[e](t.name,t.callback)})}.bind(this)),t.__binds=[])}},apply:function(t){THREE.EventDispatcher.prototype.apply(t),t.trigger=THREE.Binder._trigger,t.on=t.addEventListener,t.off=t.removeEventListener,t.dispatchEvent=t.trigger},_trigger:function(t){if(void 0!==this._listeners){var e=this._listeners[t.type];if(void 0!==e){e=e.slice();var i=e.length;t.target=this;for(var n=0;i>n;n++)e[n].call(this,t,this)}}},_polyfill:function(t,e,i){e.map(function(){return t.method}),e.length&&i(e[0])}},THREE.Bootstrap=function(t){if(!(this instanceof THREE.Bootstrap))return new THREE.Bootstrap(t);var e={init:!0,element:document.body,plugins:["core"],aliases:{},plugindb:THREE.Bootstrap.Plugins||{},aliasdb:THREE.Bootstrap.Aliases||{}};this.__options=_.defaults(t||{},e),this.__options.parameters=_.defaults(this.__options.parameters,e.parameters),this.__inited=!1,this.__destroyed=!1,this.__installed=[],this.plugins={},this.element=t.element,this.__options.init&&this.init()},THREE.Bootstrap.prototype={init:function(){function t(t){for(var e=1024;e-->0;){var n=!1,s=[];if(_.each(t,function(t){var e;(e=i[t])?(s=s.concat(e),n=!0):s.push(t)}),!n)return s;t=s}throw"Plug-in alias recursion detected"}if(!this.__inited){this.__inited=!0;{var e,i,n=this.__options,s=n.plugindb;n.aliasdb,n.element}return i=_.extend({},n.aliasdb,n.aliases),_.each(i,function(t,e){_.isArray(t)||(i[e]=[t])}),e=t(n.plugins),_.each(e,function(t){var e=s[t];if(e){if(this.plugins[t])return;var i=new e(n[t]||{},t);this.plugins[t]=i,i.install(this),this.__installed.push(i),this.trigger({type:"install",plugin:i})}}.bind(this)),this.trigger({type:"ready"}),this}},destroy:function(){if(this.__inited&&!this.__destroyed){this.__destroyed=!0;{this.__options}return this.trigger({type:"destroy"}),_.each(this.__installed.reverse(),function(t){t.uninstall(this),this.trigger({type:"uninstall",plugin:t})}.bind(this)),this.__installed=[],this.plugins={},this}}},THREE.Binder.apply(THREE.Bootstrap.prototype),THREE.Bootstrap.Plugins={},THREE.Bootstrap.Aliases={},THREE.Bootstrap.Plugin=function(t){this.options=_.defaults(t||{},this.defaults)},THREE.Bootstrap.Plugin.prototype={listen:[],defaults:{},install:function(){},uninstall:function(){},set:function(t){var e=this.options,i=_.reduce(t,function(t,i,n){return e[n]!==i&&(t[n]=i),t},{});_.extend(e,i),this.trigger({type:"change",options:t,changes:i})},get:function(){return this.options},api:function(t){return t=t||{},t.set=this.set.bind(this),t.get=this.get.bind(this),t}},THREE.Binder.apply(THREE.Bootstrap.Plugin.prototype),THREE.Bootstrap.registerPlugin=function(t,e){var i=function(e){THREE.Bootstrap.Plugin.call(this,e),this.__name=t};i.prototype=_.extend(new THREE.Bootstrap.Plugin,e),THREE.Bootstrap.Plugins[t]=i},THREE.Bootstrap.unregisterPlugin=function(t){delete THREE.Bootstrap.Plugins[t]},THREE.Bootstrap.registerAlias=function(t,e){THREE.Bootstrap.Aliases[t]=e},THREE.Bootstrap.unregisterAlias=function(t){delete THREE.Bootstrap.Aliases[t]},THREE.Bootstrap.registerAlias("empty",["renderer","bind","size","fill","loop","time"]),THREE.Bootstrap.registerAlias("core",["empty","scene","camera","render"]),THREE.Bootstrap.registerPlugin("renderer",{defaults:{klass:THREE.WebGLRenderer,parameters:{depth:!0,stencil:!0,preserveDrawingBuffer:!0,antialias:!0}},install:function(t){var e=t.renderer=new this.options.klass(this.options.parameters);t.canvas=e.domElement,t.element.appendChild(e.domElement)},uninstall:function(t){t.element.removeChild(t.renderer.domElement),delete t.renderer,delete t.canvas}}),THREE.Bootstrap.registerPlugin("bind",{install:function(t){this.three=t;var e={three:t,window:window};t.bind=THREE.Binder.bind(t,e),t.unbind=THREE.Binder.unbind(t),t.bind("install:bind",this),t.bind("uninstall:unbind",this)},uninstall:function(t){t.unbind("install:bind",this),t.unbind("uninstall:unbind",this)},bind:function(t,e){var i=t.plugin,n=i.listen;n&&n.forEach(function(t){e.bind(t,i)})},unbind:function(t,e){e.unbind(t.plugin)}}),THREE.Bootstrap.registerPlugin("size",{defaults:{width:null,height:null,aspect:null,scale:1,capWidth:1/0,capHeight:1/0},listen:["window.resize","element.resize","this.change:resize","ready:resize"],install:function(t){t.Size=this.api({renderWidth:0,renderHeight:0,viewWidth:0,viewHeight:0})},uninstall:function(t){delete t.Size},resize:function(t,e){var i,n,s,r,a,o,l,h,p=this.options,u=e.element,d=e.renderer,c=0,g=0;i=s=void 0===p.width||null==p.width?u.offsetWidth||u.innerWidth||0:p.width,n=r=void 0===p.height||null==p.height?u.offsetHeight||u.innerHeight||0:p.height,l=i/n,p.aspect&&(p.aspect>l?(n=Math.round(i/p.aspect),g=Math.floor((r-n)/2)):(i=Math.round(n*p.aspect),c=Math.floor((s-i)/2)),l=p.aspect),a=Math.min(i*p.scale,p.capWidth),o=Math.min(n*p.scale,p.capHeight),raspect=a/o,raspect>l?a=Math.round(o*l):o=Math.round(a/l),d.setSize(a,o),h=d.domElement.style,h.width=i+"px",h.height=n+"px",h.marginLeft=c+"px",h.marginTop=g+"px",_.extend(e.Size,{renderWidth:a,renderHeight:o,viewWidth:i,viewHeight:n}),e.trigger({type:"resize",renderWidth:a,renderHeight:o,viewWidth:i,viewHeight:n})}}),THREE.Bootstrap.registerPlugin("fill",{install:function(t){function e(t){var e=t.style.height;return"auto"==e||""==e}function i(t){return t.style.height="100%",t.style.margin=0,t.style.padding=0,t}t.element==document.body&&(this.applied=[t.element,document.documentElement].filter(e).map(i))},uninstall:function(){function t(t){return t.style.height="",t.style.margin="",t.style.padding="",t}this.applied&&this.applied.map(t)}}),THREE.Bootstrap.registerPlugin("loop",{defaults:{start:!0},listen:["ready"],install:function(t){this.three=t,this.running=!1,t.Loop=this.api({start:this.start.bind(this),stop:this.stop.bind(this),running:!1})},uninstall:function(){this.stop()},ready:function(){this.options.start&&this.start()},start:function(){if(!this.running){this.three.Loop.running=this.running=!0;var t=function(){this.running&&requestAnimationFrame(t),["pre","update","render","post"].map(function(t){this.three.trigger({type:t})}.bind(this))}.bind(this);requestAnimationFrame(t),this.three.trigger({type:"start"})}},stop:function(){this.running&&(this.three.Loop.running=this.running=!1,this.three.trigger({type:"stop"}))}}),THREE.Bootstrap.registerPlugin("time",{listen:["pre:tick"],install:function(t){t.Time=this.api({now:0,delta:1/60,average:0,fps:0}),this.last=0},tick:function(t,e){var i=e.Time,n=i.now=+new Date/1e3,s=this.last;if(s){var r=i.delta=n-s,a=i.average||r;i.average=a+.1*(r-a),i.fps=1/a}this.last=n},uninstall:function(t){delete t.Time}}),THREE.Bootstrap.registerPlugin("scene",{install:function(t){t.scene=new THREE.Scene},uninstall:function(t){delete t.scene}}),THREE.Bootstrap.registerPlugin("camera",{defaults:{near:.1,far:1e4,type:"perspective",fov:60,aspect:null,left:-1,right:1,bottom:-1,top:1},listen:["resize","this.change"],install:function(t){t.Camera=this.api(),t.camera=null,this.aspect=1,this.change({},t)},uninstall:function(t){delete t.Camera,delete t.camera},change:function(t,e){var i=this.options;if(e.camera&&!t.changes.type)["near","far","left","right","top","bottom","fov"].map(function(t){void 0!==i[t]&&(e.camera[t]=i[t])}.bind(this));else switch(i.type){case"perspective":e.camera=new THREE.PerspectiveCamera(i.fov,this.aspect,i.near,i.far);break;case"orthographic":e.camera=new THREE.OrthographicCamera(i.left,i.right,i.top,i.bottom,i.near,i.far)}e.camera.updateProjectionMatrix(),e.trigger({type:"camera",camera:e.camera})},resize:function(t,e){this.aspect=this.options.aspect||t.viewWidth/Math.max(1,t.viewHeight)||1,e.camera.aspect=this.aspect,e.camera.updateProjectionMatrix()}}),THREE.Bootstrap.registerPlugin("render",{listen:["render"],render:function(t,e){e.scene&&e.camera&&e.renderer.render(e.scene,e.camera)}});